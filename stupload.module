<?php

function stupload_perm() {
	return array('Workshop Add New College');
}

function stupload_menu(){
	$items = array();
	
	$items['stupload/list'] = array(
		'page callback' => 'index',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_NORMAL_ITEM,
	);
	$items['stupload/addfoss'] = array(
		'title' => 'Add New Foss Category',
		'description' => 'Add New Foss Category for ST Videos',
		'page callback' => 'drupal_get_form',
		'page arguments' => array('add_foss_form'),
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'add_foss.inc',
	);
	$items['stupload/tutorial'] = array(
		'title' => 'Add New Tutorial Name',
		'description' => 'Add New Tutorial for Foss Category',
		'page callback' => 'drupal_get_form',
		'page arguments' => array('add_tutorial_name_form'),
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'add_tutorial_name.inc',
	);
	$items['stupload/get_tutorial_levels'] = array(
		'page callback' => 'get_tutorial_levels',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_NORMAL_ITEM,
	);
	$items['stupload/upload_english'] = array(
		'title' => 'Upload English',
		'description' => 'Upload English',
		'page callback' => 'drupal_get_form',
		'page arguments' => array('upload_english_prerequest_form'),
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'upload_english_prerequest.inc',
	);
	$items['stupload/get_category_levels'] = array(
		'page callback' => 'get_category_levels',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_NORMAL_ITEM,
	);
	$items['stupload/get_category_names'] = array(
		'page callback' => 'get_category_names',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_NORMAL_ITEM,
	);
	$items['stupload/upload_english/outline'] = array(
		'title' => 'Upload English Outline',
		'description' => 'Upload English Outline',
		'page callback' => 'upload_english_outline',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'upload_english_outline.inc',
	);
	$items['stupload/upload_english/script'] = array(
		'title' => 'Upload English Script',
		'description' => 'Upload English Script',
		'page callback' => 'upload_english_script',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'upload_english_script.inc',
	);
	$items['stupload/upload_english/slide'] = array(
		'title' => 'Upload English Slide',
		'description' => 'Upload English Slide',
		'page callback' => 'upload_english_slide',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'upload_english_slide.inc',
	);
	$items['stupload/upload_english/video'] = array(
		'title' => 'Upload English Video',
		'description' => 'Upload English Video',
		'page callback' => 'upload_english_video',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'upload_english_video.inc',
	);
	$items['stupload/upload_english/codefile'] = array(
		'title' => 'Upload English Code',
		'description' => 'Upload English Code ',
		'page callback' => 'upload_english_codefile',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'upload_english_codefile.inc',
	);
	$items['stupload/upload_english/assignment'] = array(
		'title' => 'Upload English Assignment',
		'description' => 'Upload English Assignment ',
		'page callback' => 'upload_english_assignment',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'upload_english_assignment.inc',
	);
	$items['stupload/upload/summary'] = array(
		'title' => 'Upload English Summary',
		'description' => 'Upload Summary ',
		'page callback' => 'upload_summary',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'upload_summary.inc',
	);

	// other languages
	$items['stupload/upload_other_lang'] = array(
		'title' => 'Upload Other Languages',
		'description' => 'Upload Other Languages',
		'page callback' => 'drupal_get_form',
		'page arguments' => array('upload_other_lang_prerequest_form'),
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'upload_other_lang_prerequest.inc',
	);

	$items['stupload/get_languages'] = array(
		'page callback' => 'get_languages',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_NORMAL_ITEM,
	);

	$items['stupload/get_olang_tnames'] = array(
		'page callback' => 'get_olang_tnames',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_NORMAL_ITEM,
	);

	$items['stupload/upload_other_lang/outline'] = array(
		'page callback' => 'upload_olang_outline',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'upload_olang_outline.inc',
	);
	$items['stupload/upload_other_lang/script'] = array(
		'page callback' => 'upload_olang_script',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'upload_olang_script.inc',
	);
	$items['stupload/upload_other_lang/video'] = array(
		'page callback' => 'upload_olang_video',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'upload_olang_video.inc',
	);
	// update Tutorials
	$items['stupload/update_tutorial'] = array(
		'title' => 'Update Tutorials',
		'page callback' => 'drupal_get_form',
		'page arguments' => array('update_tutorial_prerequest_form'),
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'update_tutorial_prerequest.inc',
	);
	$items['stupload/update_index'] = array(
		'title' => 'Update Tutorials',
		'page callback' => 'update_index',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'update_index.inc',
	);

	$items['stupload/update/studyplan'] = array(
		'title' => 'Upload English Code',
		'description' => 'Update Studtplan ',
		'page callback' => 'update_studyplan',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'update_studyplan.inc',
	);
	$items['stupload/update/outline'] = array(
		'title' => 'Upload English Code',
		'description' => 'Update Studtplan ',
		'page callback' => 'update_outline',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'update_outline.inc',
	);
	$items['stupload/update/script'] = array(
		'title' => 'Update Script',
		'description' => 'Update Script',
		'page callback' => 'update_script',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'update_script.inc',
	);
	$items['stupload/update/video'] = array(
		'title' => 'Update Video',
		'description' => 'Update Video ',
		'page callback' => 'update_video',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'update_video.inc',
	);
	$items['stupload/update/slide'] = array(
		'title' => 'Update Slide',
		'description' => 'Update Slide ',
		'page callback' => 'update_slide',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'update_slide.inc',
	);
	$items['stupload/update/codefile'] = array(
		'title' => 'Update Codefile',
		'description' => 'Update Codefile ',
		'page callback' => 'update_codefile',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'update_codefile.inc',
	);
	$items['stupload/update/assignment'] = array(
		'title' => 'Update Assignment',
		'description' => 'Update Assignment',
		'page callback' => 'update_assignment',
		'access arguments' => array('Workshop Add New College'),
		'type' => MENU_LOCAL_TASK,
		'file' => 'update_assignment.inc',
	);

  return $items;
}

// index page

function index(){

	$output = '<h2>Upload Options</h2>';
	$output .= "<div class='upload-index-page list-link'>";
	$output .= "<a class='addfoss' href='".$GLOBALS['base_url']."/stupload/addfoss'> Add FOSS</a><br>";
	$output .= "<a class='tutorial' href='".$GLOBALS['base_url']."/stupload/tutorial'> Add Tutorial Name</a><br>";
	$output .= "<a class='upload-english' href='".$GLOBALS['base_url']."/stupload/upload_english'> Upload English</a><br>";
	$output .= "<a class='update_tutorial' href='".$GLOBALS['base_url']."/stupload/update_tutorial'>Update Tutorial</a><br>";
	$output .= "<a class='addfoss' href='".$GLOBALS['base_url']."/stupload/upload_other_lang'> Upload Other Languages</a>";
	//$output .= "<a class='addfoss' href='".$GLOBALS['base_url']."/stupload/addfoss'> Add FOSS</a>";
	//$output .= "<a class='addfoss' href='".$GLOBALS['base_url']."/stupload/addfoss'> Add FOSS</a>";
	//$output .= "<a class='addfoss' href='".$GLOBALS['base_url']."/stupload/addfoss'> Add FOSS</a>";
	$output .= "</div>";
	return $output;
}
// for add availabel tutorial levels for add tutorial names
function get_tutorial_levels(){
	if(isset($_POST['foss']) && !empty($_POST['level'])){
		$query = "select order_code, tutorial_name from tutorial_details where foss_category='".$_POST['foss']."' and tutorial_level = '".$_POST['level']."'";
		$result = db_query($query);
		$exists_order = array();
		$existing_tutorial_name = array();
		while($row = db_fetch_object($result)){
			$exists_order[] = $row->order_code;
			$existing_tutorial_name[] = $row->tutorial_name;
		}
		
	}
	$i = 1;
	while($i < 100){
		$tutorial_order_no[] = $i;
		$i++;
	}
	$available = array_diff($tutorial_order_no, $exists_order);
	$send_data = array();
	foreach($available as $a){
		$send_data['tlevels'][] = $a;
	}
	foreach($existing_tutorial_name as $names){
		$send_data['tnames'][] = $names;
	}

	echo json_encode($send_data);
	exit;
}
// getting tutorial level
function get_category_levels(){
	if(isset($_POST['foss'])){
		$query = "select distinct tutorial_level from tutorial_details where foss_category='".$_POST['foss']."'";
		$result = db_query($query);
		$output = array();
		while($row = db_fetch_object($result)){
			$output[] = $row;
			//$output[] = '2';
		}
		echo json_encode($output);
		exit;
	}
}

// getting tutorial names
function get_category_names(){
	if(isset($_POST['level']) && isset($_POST['foss'])){
		//$query = "select distinct tutorial_name from tutorial_details where tutorial_level='".$_POST['level']."'";

		$query = "SELECT  tutorial_name FROM tutorial_details WHERE foss_category='".$_POST['foss']."' and tutorial_level =  '".$_POST['level']."' AND tutorial_details.id NOT IN ( SELECT tutorial_detail_id FROM tutorial_resources)";
		$result = db_query($query);
		$output = array();
		while($row = db_fetch_object($result)){
			$output[] = $row;
		}
		echo json_encode($output);
		exit;
	}
}

// ******** for other languages ************
// getting other languages
// function get_languages(){
// 	if(isset($_POST['level']) && isset($_POST['foss'])){

// 		$query = "SELECT  tl.name FROM tutorial_languages tl WHERE  tl.name NOT IN ( SELECT language FROM tutorial_resources where tutorial_detail_id in (select id from tutorial_details where foss_category='".$_POST['foss']."' and tutorial_level='".$_POST['level']."'))";
// 		$result = db_query($query);
// 		$output = array();
// 		while($row = db_fetch_object($result)){
// 			$output[] = $row;
// 		}
// 		echo json_encode($output);
// 		exit;
// 	}
// }

// getting tutorial names
function get_olang_tnames(){
	if(isset($_POST['level']) && isset($_POST['foss']) && isset($_POST['lang']) && isset($_POST['flag'])){
		if($_POST['flag'] == 0){
			$query = "SELECT  tutorial_name FROM tutorial_details WHERE foss_category='".$_POST['foss']."' and tutorial_level =  '".$_POST['level']."' AND tutorial_details.id NOT IN ( SELECT tutorial_detail_id FROM tutorial_resources where language='".$_POST['lang']."')";
		}else{
			$query = "SELECT  tutorial_name FROM tutorial_details WHERE foss_category='".$_POST['foss']."' and tutorial_level =  '".$_POST['level']."'";
		}
		$result = db_query($query);
		$output = array();
		while($row = db_fetch_object($result)){
			$output[] = $row;
		}
		echo json_encode($output);
		exit;
	}
}


function read_ziparchive($file_path){

	//Create object
	$zip = new ZipArchive();
	//Open the archive2.zip
	if ($zip->open($file_path) !== TRUE) {
	    return '<span>Could not open archive</span>';
	}else{
		//Get the number of files in archive2.zip
		$numFiles = $zip->numFiles;

		//Iterate over the file list
		$file_data = "<ul class='archive-files'>";
		for ($i=0; $i<$numFiles; $i++) {
		    //Get the details of an entry defined by its index
		    $tmp = $zip->statIndex($i);
		    $file_data .= '<li>'.$tmp['name'].'</li>';
		}
		$file_data .= "</ul>";
		// close archive
		$zip->close();
		return $file_data;
		
	}

}

function get_file_extension($name){

}

function get_file_name($name){
	return str_replace('/', '', substr($name, strripos($name, '/')));
}



?>
